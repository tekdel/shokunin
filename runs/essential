#!/bin/bash
# runs/essential - Essential system packages

sudo pacman -S --needed --noconfirm \
    base-devel \
    git \
    vim \
    neovim \
    wget \
    curl \
    htop \
    btop \
    man-db \
    man-pages \
    bash-completion \
    less \
    unzip \
    zip \
    p7zip \
    tar \
    rsync \
    openssh \
    iwd \
    impala \
    bluez \
    bluez-utils \
    bluetui \
    inetutils \
    usbutils \
    pciutils \
    plymouth \
    gnome-keyring \
    seahorse \
    power-profiles-daemon \
    bolt

# Configure polkit to allow wheel group to manage iwd and bluetooth
echo "Configuring polkit rules for iwd and bluetooth..."
sudo mkdir -p /etc/polkit-1/rules.d

sudo tee /etc/polkit-1/rules.d/50-net-wifi-bluetooth.rules > /dev/null << 'EOF'
// Allow wheel group members to control iwd (WiFi) without password
polkit.addRule(function(action, subject) {
    if (action.id.indexOf("net.connman.iwd.") == 0 &&
        subject.isInGroup("wheel")) {
        return polkit.Result.YES;
    }
});

// Allow wheel group members to control bluetooth without password
polkit.addRule(function(action, subject) {
    if (action.id.indexOf("org.bluez.") == 0 &&
        subject.isInGroup("wheel")) {
        return polkit.Result.YES;
    }
});
EOF

# Configure iwd to handle DHCP (IP assignment)
echo "Configuring iwd for automatic IP assignment..."
sudo mkdir -p /etc/iwd
sudo tee /etc/iwd/main.conf > /dev/null << 'EOF'
[General]
EnableNetworkConfiguration=true

[Network]
NameResolvingService=systemd
EOF

# Enable services
sudo systemctl enable iwd || echo "Note: systemctl may fail in chroot"
sudo systemctl enable systemd-resolved || echo "Note: systemctl may fail in chroot"
sudo systemctl enable bluetooth || echo "Note: systemctl may fail in chroot"

echo "Essential packages installed successfully!"
echo "Note: Using iwd for WiFi management (managed via impala TUI)"
