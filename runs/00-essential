#!/bin/bash
# runs/essential - Essential system packages

# Graphics drivers (AMD + Intel for Lenovo Z13 and Framework laptops)
sudo pacman -S --needed --noconfirm \
    mesa \
    vulkan-radeon \
    vulkan-intel \
    libva-mesa-driver \
    libva-intel-driver \
    intel-media-driver \
    lib32-mesa \
    lib32-vulkan-radeon \
    lib32-vulkan-intel

# AMD firmware (for Lenovo Z13 and AMD Framework)
sudo pacman -S --needed --noconfirm \
    linux-firmware \
    amd-ucode \
    intel-ucode

sudo pacman -S --needed --noconfirm \
    base-devel \
    git \
    vim \
    neovim \
    wget \
    curl \
    htop \
    btop \
    man-db \
    man-pages \
    bash-completion \
    less \
    unzip \
    zip \
    p7zip \
    tar \
    rsync \
    openssh \
    iwd \
    impala \
    bluez \
    bluez-utils \
    bluetui \
    inetutils \
    usbutils \
    pciutils \
    plymouth \
    gnome-keyring \
    seahorse \
    power-profiles-daemon \
    bolt

# Configure polkit to allow wheel group to manage iwd and bluetooth
echo "Configuring polkit rules for iwd and bluetooth..."
sudo mkdir -p /etc/polkit-1/rules.d

sudo tee /etc/polkit-1/rules.d/50-net-wifi-bluetooth.rules > /dev/null << 'EOF'
// Allow wheel group members to control iwd (WiFi) without password
polkit.addRule(function(action, subject) {
    if (action.id.indexOf("net.connman.iwd.") == 0 &&
        subject.isInGroup("wheel")) {
        return polkit.Result.YES;
    }
});

// Allow wheel group members to control bluetooth without password
polkit.addRule(function(action, subject) {
    if (action.id.indexOf("org.bluez.") == 0 &&
        subject.isInGroup("wheel")) {
        return polkit.Result.YES;
    }
});
EOF

# Configure iwd to handle DHCP (IP assignment)
echo "Configuring iwd for automatic IP assignment..."
sudo mkdir -p /etc/iwd
sudo tee /etc/iwd/main.conf > /dev/null << 'EOF'
[General]
EnableNetworkConfiguration=true

[Network]
NameResolvingService=systemd
EOF

# Configure systemd-networkd for ethernet (DHCP)
echo "Configuring systemd-networkd for ethernet..."
sudo mkdir -p /etc/systemd/network
sudo tee /etc/systemd/network/20-wired.network > /dev/null << 'EOF'
[Match]
Name=en*
Name=eth*

[Network]
DHCP=yes
DNS=1.1.1.1
DNS=8.8.8.8

[DHCPv4]
RouteMetric=100
EOF

# Configure systemd-resolved with fallback DNS (for WiFi via iwd)
echo "Configuring systemd-resolved with fallback DNS..."
sudo mkdir -p /etc/systemd/resolved.conf.d
sudo tee /etc/systemd/resolved.conf.d/dns.conf > /dev/null << 'EOF'
[Resolve]
DNS=1.1.1.1 8.8.8.8
FallbackDNS=1.0.0.1 8.8.4.4
EOF

# Enable services
sudo systemctl enable iwd || echo "Note: systemctl may fail in chroot"
sudo systemctl enable systemd-networkd || echo "Note: systemctl may fail in chroot"
sudo systemctl enable systemd-resolved || echo "Note: systemctl may fail in chroot"
sudo systemctl enable bluetooth || echo "Note: systemctl may fail in chroot"

echo "Essential packages installed successfully!"
echo "Note: Using iwd for WiFi, systemd-networkd for ethernet"
