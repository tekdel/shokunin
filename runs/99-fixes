#!/bin/bash
# runs/99-fixes - Apply system fixes for existing installations
# Note: Most configuration is now handled by 00-essential and install/* scripts
# This script only contains fixes that might be needed on older systems

echo "Applying system fixes..."

# Enable multilib repository for 32-bit libraries (Steam, Wine, etc.)
if ! grep -q "^\[multilib\]" /etc/pacman.conf; then
    echo "Enabling multilib repository..."
    sudo sed -i '/^#\[multilib\]/,/^#Include/ s/^#//' /etc/pacman.conf
    sudo pacman -Sy
    echo "✓ Multilib enabled"
fi

# Fix pacman keyring if corrupted
if ! pacman-key --list-keys &>/dev/null 2>&1; then
    echo "Fixing pacman keyring..."
    sudo rm -f /var/lib/pacman/db.lck
    sudo rm -rf /etc/pacman.d/gnupg
    sudo pacman-key --init
    sudo pacman-key --populate archlinux
    sudo pacman -Sy --noconfirm archlinux-keyring
    echo "✓ Keyring fixed"
fi

# Fix broken plymouth-encrypt if it was applied on older installations
if grep -q "plymouth-encrypt" /etc/mkinitcpio.conf 2>/dev/null; then
    echo "Fixing broken plymouth-encrypt (reverting to encrypt)..."
    sudo sed -i 's/plymouth-encrypt/encrypt/' /etc/mkinitcpio.conf
    sudo mkinitcpio -P
    echo "✓ Plymouth hooks fixed"
fi

echo ""
echo "System fixes applied!"
