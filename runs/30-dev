#!/bin/bash
# runs/dev - Development tools and languages

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$SCRIPT_DIR/../dotfiles"

# Build tools
sudo pacman -S --needed --noconfirm \
    cmake \
    make \
    gcc \
    clang \
    llvm

# Development utilities (rustup instead of rust - rustup manages toolchains)
sudo pacman -S --needed --noconfirm \
    shellcheck \
    shfmt \
    mise \
    go \
    rustup \
    redis

# Infrastructure as Code
sudo pacman -S --needed --noconfirm \
    terraform \
    terragrunt

# Refresh shell's command cache so mise is found
hash -r

# Initialize rustup if not already done
if command -v rustup &>/dev/null && ! rustup show active-toolchain &>/dev/null; then
    echo "Initializing Rust toolchain via rustup..."
    rustup default stable
fi

# Copy mise config to XDG location
mkdir -p ~/.config/mise
if [ -f "$DOTFILES_DIR/.mise.toml" ]; then
    cp "$DOTFILES_DIR/.mise.toml" ~/.config/mise/config.toml
    mise trust ~/.config/mise/config.toml 2>/dev/null || true
    # Remove old location if exists
    rm -f ~/.mise.toml
    echo "âœ“ mise config copied to ~/.config/mise/config.toml"
fi

# Install languages via mise (Node.js, Python)
echo "Installing Node.js and Python via mise..."
mise settings set node.gpg_verify false
mise install node@lts -y
mise install python@3.12 -y
mise use --global node@lts
mise use --global python@3.12

# Activate mise for current shell so npm is available
eval "$(mise activate bash)"
hash -r

# Install tree-sitter-cli for Neovim (official repos)
sudo pacman -S --needed --noconfirm tree-sitter-cli

echo "Development tools installed successfully!"
echo "Node.js and Python managed by mise"
echo "Restart your shell or run: eval \"\$(mise activate zsh)\""
