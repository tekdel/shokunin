#!/bin/bash
# runs/dotfiles - Update dotfiles and configs from repository

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$SCRIPT_DIR/../dotfiles"

echo "Updating dotfiles from repository..."

# Create config directories
mkdir -p ~/.config/hypr
mkdir -p ~/.config/waybar
mkdir -p ~/.config/alacritty
mkdir -p ~/.config/nvim
mkdir -p ~/.config/tmux
mkdir -p ~/.local/bin

# Hyprland
if [ -d "$DOTFILES_DIR/hypr" ]; then
    cp -r "$DOTFILES_DIR/hypr/"* ~/.config/hypr/
    echo "✓ Hyprland config updated"
fi

# Waybar
if [ -d "$DOTFILES_DIR/waybar" ]; then
    cp -r "$DOTFILES_DIR/waybar/"* ~/.config/waybar/
    echo "✓ Waybar config updated"
fi

# Alacritty
if [ -d "$DOTFILES_DIR/alacritty" ]; then
    cp -r "$DOTFILES_DIR/alacritty/"* ~/.config/alacritty/
    echo "✓ Alacritty config updated"
fi

# Neovim
if [ -d "$DOTFILES_DIR/nvim" ]; then
    cp -r "$DOTFILES_DIR/nvim/"* ~/.config/nvim/
    echo "✓ Neovim config updated"
fi

# btop
if [ -d "$DOTFILES_DIR/btop" ]; then
    mkdir -p ~/.config/btop
    cp -r "$DOTFILES_DIR/btop/"* ~/.config/btop/
    echo "✓ btop config updated"
fi

# Kanshi (monitor hotplug)
if [ -d "$DOTFILES_DIR/kanshi" ]; then
    mkdir -p ~/.config/kanshi
    cp -r "$DOTFILES_DIR/kanshi/"* ~/.config/kanshi/
    echo "✓ Kanshi config updated"
fi

# Tmux
if [ -f "$DOTFILES_DIR/tmux/.tmux.conf" ]; then
    mkdir -p ~/.config/tmux
    cp "$DOTFILES_DIR/tmux/.tmux.conf" ~/.config/tmux/tmux.conf
    echo "✓ Tmux config updated"
fi

# Shell configs
if [ -f "$DOTFILES_DIR/zsh/.zshrc" ]; then
    cp "$DOTFILES_DIR/zsh/.zshrc" ~/
    echo "✓ .zshrc updated"
fi

if [ -f "$DOTFILES_DIR/zsh/.zprofile" ]; then
    cp "$DOTFILES_DIR/zsh/.zprofile" ~/
    echo "✓ .zprofile updated"
fi

if [ -f "$DOTFILES_DIR/bash/.bashrc" ]; then
    cp "$DOTFILES_DIR/bash/.bashrc" ~/
    echo "✓ .bashrc updated"
fi

if [ -f "$DOTFILES_DIR/bash/.bash_profile" ]; then
    cp "$DOTFILES_DIR/bash/.bash_profile" ~/
    echo "✓ .bash_profile updated"
fi

# Git config
if [ -f "$DOTFILES_DIR/git/.gitconfig" ]; then
    cp "$DOTFILES_DIR/git/.gitconfig" ~/
    echo "✓ .gitconfig updated"
fi

if [ -f "$DOTFILES_DIR/git/.gitignore_global" ]; then
    cp "$DOTFILES_DIR/git/.gitignore_global" ~/
    echo "✓ .gitignore_global updated"
fi

# Mise config
if [ -f "$DOTFILES_DIR/.mise.toml" ]; then
    cp "$DOTFILES_DIR/.mise.toml" ~/
    echo "✓ .mise.toml updated"
fi

# Local bin scripts
if [ -d "$DOTFILES_DIR/bin" ]; then
    cp -r "$DOTFILES_DIR/bin/"* ~/.local/bin/
    chmod +x ~/.local/bin/*
    echo "✓ Local bin scripts updated"
fi

# Install mise tools (Node.js, Python) if mise is available
if command -v mise >/dev/null 2>&1; then
    # Trust the config file first
    if [ -f ~/.mise.toml ]; then
        mise trust ~/.mise.toml 2>/dev/null || true
    fi
    echo "Installing mise tools (Node.js, Python)..."
    # Skip GPG verification (keyservers are unreliable)
    mise settings set node.gpg_verify false
    # Explicitly install tools
    mise install node@lts -y
    mise install python@3.12 -y
    mise use --global node@lts
    mise use --global python@3.12
    echo "✓ mise tools installed"
fi

echo ""
echo "Dotfiles updated successfully!"
echo "Run 'hyprctl reload' or log out/in for changes to take effect."
